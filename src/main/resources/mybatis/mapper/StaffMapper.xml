<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.orderbt.Mapper.StaffMapper">
    <select id="getEstimateGrid" parameterType="SearchDto" resultType="EstimateDto">
        select *
        from web.estimate a
        left join web.order b on a.order_id = b.id
        left join web.reservation c on a.reservation_id = c.id
        where 1=1
        <if test="keywordList != null">
            AND
            <choose>
                <when test="category == 'name'">
                    <foreach collection="inq" item="item"
                             index="index" open="(" close=")" separator="or">
                        b.battery_cell LIKE '%' || #{item} || '%'
                        or b.cell_model LIKE '%' || #{item} || '%'
                        or b.voltage LIKE '%' || #{item} || '%'
                        or b.ampere LIKE '%' || #{item} || '%'
                        or b.pcm LIKE '%' || #{item} || '%'
                    </foreach>
                </when>
                <when test="category == 'id'">
                    <foreach collection="inq" item="item"
                             index="index" open="(" close=")" separator="or">
                        a.id LIKE '%' || #{item} || '%'
                    </foreach>
                </when>
                <when test="category == 'company'">
                    <foreach collection="inq" item="item"
                             index="index" open="(" close=")" separator="or">
                        a.company LIKE '%' || #{item} || '%'
                        or a.name LIKE '%' || #{item} || '%'
                        or a.email LIKE '%' || #{item} || '%'
                        or a.tel LIKE '%' || #{item} || '%'
                    </foreach>
                </when>
                <otherwise>
                    <foreach collection="keywordList" item="item"
                             index="index" open="(" close=")" separator="or">
                        a.company LIKE '%' || #{item} || '%'
                        or a.name LIKE '%' || #{item} || '%'
                        or a.email LIKE '%' || #{item} || '%'
                        or a.tel LIKE '%' || #{item} || '%'
                        or a.id LIKE '%' || #{item} || '%'
                        or b.battery_cell LIKE '%' || #{item} || '%'
                        or b.cell_model LIKE '%' || #{item} || '%'
                        or b.voltage LIKE '%' || #{item} || '%'
                        or b.ampere LIKE '%' || #{item} || '%'
                        or b.pcm LIKE '%' || #{item} || '%'
                    </foreach>
                </otherwise>
            </choose>
        </if>
        order by a.cret_dt desc
    </select>



    <update id="saveEstimate" parameterType="estimateDto">
        update web.reservation
        set consult_yn = #{consultYn}
        <if test='consultYn == "Y"'>
            ,consult_dt = NOW()
        </if>
        <if test='consultYn == "N"'>
            ,consult_dt = null
        </if>
        where id = (select reservation_id from web.estimate where id = #{id})
    </update>

    <insert id="joinStaff" parameterType="StaffDto">
        INSERT INTO web.staff
        (id, password, name , phone_num, email, password_key, active_yn, memo, cret_dt)
        VALUES (#{id}, #{password}, #{name}, #{phoneNum}, #{email}, #{passwordKey}, 'Y', #{memo}, NOW())
    </insert>

    <select id="getEstimateBoard" resultType="hashMap">
        select
                (select count(id) from web.estimate) as totalCnt,
                (select count(id) from web.reservation where consult_yn = 'Y') as consultYCnt,
                (select count(id) from web.reservation where consult_yn = 'N') as consultNCnt,
                (select type FROM web.reservation GROUP BY type HAVING COUNT(type) > 1 order by count(type) desc limit 1) as maxType
    </select>
</mapper>